#!/usr/bin/env bash
set -euo pipefail

DIR="tests/fixtures"
PASS=0
FAIL=0
ERRORS=""

for input in "$DIR"/input/*; do
    name=$(basename "$input")
    expected="$DIR/expected/$name"

    if [ ! -f "$expected" ]; then
        ERRORS+="  ⚠ missing expected: $name\n"
        FAIL=$((FAIL + 1))
        continue
    fi

    actual=$(cargo run -q -- "$input")
    if diff -q <(echo "$actual") "$expected" > /dev/null 2>&1; then
        PASS=$((PASS + 1))
    else
        ERRORS+="  ✗ $name\n"
        diff --color <(echo "$actual") "$expected" || true
        FAIL=$((FAIL + 1))
    fi
done

echo ""
if [ $FAIL -eq 0 ]; then
    echo "✅ all $PASS fixtures passed"
else
    echo -e "$ERRORS"
    echo "❌ $FAIL failed, $PASS passed"
    exit 1
fi
