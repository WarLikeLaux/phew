#!/usr/bin/env bash
set -uo pipefail

DIR="tests/fixtures"
PASS=0
FAIL=0
TOTAL=0
ERRORS=""

trap 'rm -f /tmp/phrust_actual_* /tmp/phrust_idem_* /tmp/phrust_err_*' EXIT

# orphan check: expected without input
for expected in "$DIR"/expected/*; do
    name=$(basename "$expected")
    if [ ! -f "$DIR/input/$name" ]; then
        ERRORS+="  ⚠ orphan expected (no input): $name\n"
        FAIL=$((FAIL + 1))
        TOTAL=$((TOTAL + 1))
    fi
done

for input in "$DIR"/input/*; do
    name=$(basename "$input")
    expected="$DIR/expected/$name"
    TOTAL=$((TOTAL + 1))

    if [ ! -f "$expected" ]; then
        ERRORS+="  ⚠ missing expected: $name\n"
        FAIL=$((FAIL + 1))
        continue
    fi

    actual_file="/tmp/phrust_actual_$name"
    err_file="/tmp/phrust_err_$name"

    cargo run -q -- "$input" > "$actual_file" 2> "$err_file"
    exit_code=$?

    if [ "$exit_code" -ne 0 ]; then
        err_msg=$(cat "$err_file")
        ERRORS+="  ✗ $name (exit $exit_code: $err_msg)\n"
        FAIL=$((FAIL + 1))
        continue
    fi

    if diff -q "$expected" "$actual_file" > /dev/null 2>&1; then
        idem_file="/tmp/phrust_idem_$name"
        cargo run -q -- "$actual_file" > "$idem_file" 2>/dev/null

        if diff -q "$actual_file" "$idem_file" > /dev/null 2>&1; then
            PASS=$((PASS + 1))
        else
            ERRORS+="  ✗ $name (not idempotent — second pass differs)\n"
            FAIL=$((FAIL + 1))
        fi
    else
        ERRORS+="  ✗ $name (output differs from expected)\n"
        FAIL=$((FAIL + 1))
    fi
done

echo ""
if [ -n "$ERRORS" ]; then
    echo "Failures:"
    echo -e "$ERRORS"
fi

echo "Results:"
echo "  Total:  $TOTAL"
echo "  Passed: $PASS"
echo "  Failed: $FAIL"

if [ "$FAIL" -eq 0 ]; then
    echo ""
    echo "✅ All fixtures passed!"
else
    exit 1
fi
